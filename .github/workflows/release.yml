name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  OCICL_REPO: https://github.com/ocicl/ocicl

jobs:
  build-linux:
    name: Linux x86_64 Binary
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SBCL
      run: |
        sudo apt-get update
        sudo apt-get install -y sbcl

    - name: Install ocicl
      run: |
        OCICL_VERSION=$(curl -s https://api.github.com/repos/ocicl/ocicl/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -sLO https://github.com/ocicl/ocicl/releases/latest/download/ocicl_${OCICL_VERSION}-1_amd64.deb
        sudo dpkg -i ocicl_${OCICL_VERSION}-1_amd64.deb
        ocicl setup > ~/.sbclrc
        ocicl version

    - name: Install dependencies
      run: ocicl install

    - name: Build ag-protoc
      run: make ag-protoc

    - name: Generate protobuf code
      run: make src/grpc-proto.lisp

    - name: Run tests
      run: |
        sbcl --non-interactive \
          --eval "(asdf:load-system :fiveam)" \
          --eval "(asdf:load-system :cloodoo)" \
          --load tests/tests.lisp \
          --eval "(cloodoo-tests:run-tests)"

    - name: Build executable
      run: make cloodoo

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Package tarball
      run: |
        TARDIR="cloodoo-${{ steps.version.outputs.VERSION }}-linux-x86_64"
        mkdir "$TARDIR"
        cp cloodoo LICENSE README.md "$TARDIR/"

        # Include GNOME extension
        mkdir -p "$TARDIR/gnome-extension/schemas"
        cp gnome-extension/extension.js gnome-extension/prefs.js \
           gnome-extension/stylesheet.css gnome-extension/metadata.json \
           "$TARDIR/gnome-extension/"
        cp gnome-extension/schemas/org.gnome.shell.extensions.cloodoo.gschema.xml \
           "$TARDIR/gnome-extension/schemas/"

        # Include browser extension
        cp -r browser-extension "$TARDIR/browser-extension"
        rm -f "$TARDIR/browser-extension/.gitignore"

        tar czf "${TARDIR}.tar.gz" "$TARDIR"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-x86_64-tarball
        path: cloodoo-*-linux-x86_64.tar.gz
        retention-days: 5

  build-rpm:
    name: Fedora RPM
    runs-on: ubuntu-latest
    container: fedora:latest

    steps:
    - name: Install build tools
      run: |
        dnf install -y git make gcc gcc-c++ \
          sbcl sqlite-devel openssl-devel libzstd-devel \
          rpm-build rpmdevtools libfixposix-devel

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Bootstrap ocicl from source
      run: |
        cd /tmp
        git clone --depth 1 ${{ env.OCICL_REPO }}.git
        cd ocicl
        sbcl --load setup.lisp
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        export PATH="$HOME/.local/bin:$PATH"
        cd "$GITHUB_WORKSPACE"
        ocicl setup > ~/.sbclrc

    - name: Install dependencies
      run: ocicl install

    - name: Build ag-protoc
      run: make ag-protoc

    - name: Generate protobuf code
      run: make src/grpc-proto.lisp

    - name: Build executable
      run: make cloodoo

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Set up rpmbuild tree
      run: rpmdev-setuptree

    - name: Create source tarball for rpmbuild
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        mkdir -p /tmp/cloodoo-${VERSION}
        cp cloodoo LICENSE README.md /tmp/cloodoo-${VERSION}/

        # Include GNOME extension
        mkdir -p /tmp/cloodoo-${VERSION}/gnome-extension/schemas
        cp gnome-extension/extension.js gnome-extension/prefs.js \
           gnome-extension/stylesheet.css gnome-extension/metadata.json \
           /tmp/cloodoo-${VERSION}/gnome-extension/
        cp gnome-extension/schemas/org.gnome.shell.extensions.cloodoo.gschema.xml \
           /tmp/cloodoo-${VERSION}/gnome-extension/schemas/

        # Include browser extension
        cp -r browser-extension /tmp/cloodoo-${VERSION}/browser-extension
        rm -f /tmp/cloodoo-${VERSION}/browser-extension/.gitignore

        tar czf ~/rpmbuild/SOURCES/cloodoo-${VERSION}.tar.gz -C /tmp cloodoo-${VERSION}

    - name: Build RPM
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        rpmbuild -bb \
          --define "version ${VERSION}" \
          --define "_binary_payload w6.zstdio" \
          releng/cloodoo.spec

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fedora-rpm
        path: ~/rpmbuild/RPMS/**/*.rpm
        retention-days: 5

  build-deb:
    name: Debian/Ubuntu DEB
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sbcl gcc make git \
          libsqlite3-dev libssl-dev libzstd-dev dpkg-dev fakeroot

    - name: Install ocicl
      run: |
        OCICL_VERSION=$(curl -s https://api.github.com/repos/ocicl/ocicl/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        curl -sLO https://github.com/ocicl/ocicl/releases/latest/download/ocicl_${OCICL_VERSION}-1_amd64.deb
        sudo dpkg -i ocicl_${OCICL_VERSION}-1_amd64.deb
        ocicl setup > ~/.sbclrc

    - name: Install dependencies
      run: ocicl install

    - name: Build ag-protoc
      run: make ag-protoc

    - name: Generate protobuf code
      run: make src/grpc-proto.lisp

    - name: Build executable
      run: make cloodoo

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Build DEB package
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        PKG="cloodoo_${VERSION}-1_amd64"
        mkdir -p "${PKG}/DEBIAN"
        mkdir -p "${PKG}/usr/bin"

        cp cloodoo "${PKG}/usr/bin/"
        chmod 755 "${PKG}/usr/bin/cloodoo"

        sed "s/@VERSION@/${VERSION}/g" releng/debian/control > "${PKG}/DEBIAN/control"
        cp releng/debian/copyright "${PKG}/DEBIAN/copyright"
        cp releng/debian/postinst "${PKG}/DEBIAN/postinst"
        cp releng/debian/postrm "${PKG}/DEBIAN/postrm"
        chmod 755 "${PKG}/DEBIAN/postinst" "${PKG}/DEBIAN/postrm"

        # GNOME Shell extension
        GNOME_DIR="${PKG}/usr/share/gnome-shell/extensions/cloodoo-screenshot@moxielogic.com"
        mkdir -p "${GNOME_DIR}/schemas"
        cp gnome-extension/extension.js gnome-extension/prefs.js \
           gnome-extension/stylesheet.css gnome-extension/metadata.json \
           "${GNOME_DIR}/"
        cp gnome-extension/schemas/org.gnome.shell.extensions.cloodoo.gschema.xml \
           "${GNOME_DIR}/schemas/"

        # GSettings schema (system-wide)
        mkdir -p "${PKG}/usr/share/glib-2.0/schemas"
        cp gnome-extension/schemas/org.gnome.shell.extensions.cloodoo.gschema.xml \
           "${PKG}/usr/share/glib-2.0/schemas/"

        # Browser extension
        BROWSER_DIR="${PKG}/usr/share/cloodoo/browser-extension"
        mkdir -p "${BROWSER_DIR}/icons" "${BROWSER_DIR}/popup" "${BROWSER_DIR}/options"
        cp browser-extension/manifest.json browser-extension/background.js \
           browser-extension/content.js browser-extension/content.css \
           "${BROWSER_DIR}/"
        cp browser-extension/icons/* "${BROWSER_DIR}/icons/"
        cp browser-extension/popup/* "${BROWSER_DIR}/popup/"
        cp browser-extension/options/* "${BROWSER_DIR}/options/"

        fakeroot dpkg-deb --build "${PKG}"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ubuntu-deb
        path: cloodoo_*_amd64.deb
        retention-days: 5

  build-macos-arm64:
    name: macOS ARM64
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install sbcl libfixposix

    - name: Bootstrap ocicl from source
      run: |
        cd /tmp
        git clone --depth 1 ${{ env.OCICL_REPO }}.git
        cd ocicl
        sbcl --load setup.lisp
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        export PATH="$HOME/.local/bin:$PATH"
        cd "$GITHUB_WORKSPACE"
        ocicl setup > ~/.sbclrc

    - name: Install dependencies
      run: ocicl install

    - name: Build ag-protoc
      run: make ag-protoc

    - name: Generate protobuf code
      run: make src/grpc-proto.lisp

    - name: Build executable
      run: make cloodoo

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Package tarball
      run: |
        TARDIR="cloodoo-${{ steps.version.outputs.VERSION }}-macos-arm64"
        mkdir "$TARDIR"
        cp cloodoo LICENSE README.md "$TARDIR/"
        tar czf "${TARDIR}.tar.gz" "$TARDIR"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-tarball
        path: cloodoo-*-macos-arm64.tar.gz
        retention-days: 5

  build-macos-x64:
    name: macOS x64
    runs-on: macos-15-intel

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install sbcl libfixposix

    - name: Bootstrap ocicl from source
      run: |
        cd /tmp
        git clone --depth 1 ${{ env.OCICL_REPO }}.git
        cd ocicl
        sbcl --load setup.lisp
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        export PATH="$HOME/.local/bin:$PATH"
        cd "$GITHUB_WORKSPACE"
        ocicl setup > ~/.sbclrc

    - name: Install dependencies
      run: ocicl install

    - name: Build ag-protoc
      run: make ag-protoc

    - name: Generate protobuf code
      run: make src/grpc-proto.lisp

    - name: Build executable
      run: make cloodoo

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Package tarball
      run: |
        TARDIR="cloodoo-${{ steps.version.outputs.VERSION }}-macos-x64"
        mkdir "$TARDIR"
        cp cloodoo LICENSE README.md "$TARDIR/"
        tar czf "${TARDIR}.tar.gz" "$TARDIR"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-x64-tarball
        path: cloodoo-*-macos-x64.tar.gz
        retention-days: 5

  build-android:
    name: Android APK
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Build debug APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Run unit tests
      run: |
        cd android
        ./gradlew test --no-daemon --stacktrace

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Rename APK
      run: |
        cp android/app/build/outputs/apk/debug/app-debug.apk \
           cloodoo-${{ steps.version.outputs.VERSION }}-android.apk

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: cloodoo-*-android.apk
        retention-days: 5

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-rpm
      - build-deb
      - build-macos-arm64
      - build-macos-x64
      - build-android

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -type f | sort

    - name: Gather release files
      run: |
        mkdir release-files
        find artifacts -type f \( -name '*.tar.gz' -o -name '*.rpm' -o -name '*.deb' -o -name '*.apk' \) \
          -exec cp {} release-files/ \;
        ls -la release-files/

    - name: Load release notes (if available)
      id: notes
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        NOTES_FILE="docs/release-notes/RELEASE-NOTES-${VERSION}.md"
        if [ -f "$NOTES_FILE" ]; then
          echo "NOTES_FILE=$NOTES_FILE" >> "$GITHUB_OUTPUT"
        else
          echo "NOTES_FILE=" >> "$GITHUB_OUTPUT"
        fi

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        NOTES_FILE="${{ steps.notes.outputs.NOTES_FILE }}"
        NOTES_FLAG=""
        if [ -n "$NOTES_FILE" ]; then
          NOTES_FLAG="--notes-file $NOTES_FILE"
        else
          NOTES_FLAG="--generate-notes"
        fi

        gh release create "${{ github.ref_name }}" \
          --title "Cloodoo v${VERSION}" \
          $NOTES_FLAG \
          release-files/*
